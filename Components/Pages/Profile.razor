@page "/profile"
@rendermode InteractiveServer
@inject ICustomerAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>T√†i kho·∫£n - Stuffsus</PageTitle>

@if (!AuthService.IsAuthenticated)
{
    <div class="not-authenticated">
        <h2>Vui l√≤ng ƒëƒÉng nh·∫≠p</h2>
        <p>B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem th√¥ng tin t√†i kho·∫£n</p>
        <a href="/login?returnUrl=/profile" class="btn btn-primary btn-lg">ƒêƒÉng nh·∫≠p</a>
    </div>
}
else
{
    <div class="profile-page">
        <div class="container">
            <h1 class="page-title">T√†i kho·∫£n c·ªßa t√¥i</h1>

            <div class="profile-layout">
                <!-- Sidebar -->
                <aside class="profile-sidebar">
                    <div class="profile-avatar">
                        <div class="avatar-circle">
                            @(AuthService.CurrentCustomer?.Name?.Substring(0, 1).ToUpper() ?? "K")
                        </div>
                        <h3 class="customer-name">@AuthService.CurrentCustomer?.Name</h3>
                        <p class="customer-email">@AuthService.CurrentCustomer?.Email</p>
                    </div>

                    <nav class="profile-nav">
                        <a href="/profile" class="nav-item active">
                            <span class="icon">üë§</span>
                            Th√¥ng tin c√° nh√¢n
                        </a>
                        <a href="/orders" class="nav-item">
                            <span class="icon">üì¶</span>
                            ƒê∆°n h√†ng c·ªßa t√¥i
                        </a>
                        <button class="nav-item logout-btn" @onclick="HandleLogout">
                            <span class="icon">üö™</span>
                            ƒêƒÉng xu·∫•t
                        </button>
                    </nav>
                </aside>

                <!-- Main Content -->
                <div class="profile-content">
                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <div class="alert alert-success">
                            @successMessage
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-error">
                            @errorMessage
                        </div>
                    }

                    <div class="content-card">
                        <div class="card-header">
                            <h2>Th√¥ng tin c√° nh√¢n</h2>
                            @if (!isEditing)
                            {
                                <button class="btn btn-secondary btn-sm" @onclick="StartEditing">
                                    ‚úèÔ∏è Ch·ªânh s·ª≠a
                                </button>
                            }
                        </div>

                        @if (isEditing)
                        {
                            <EditForm Model="@editModel" OnValidSubmit="HandleUpdateProfile" class="profile-form">
                                <DataAnnotationsValidator />

                                <div class="form-group">
                                    <label class="form-label">H·ªç v√† t√™n</label>
                                    <InputText @bind-Value="editModel.Name" class="form-input" placeholder="Nh·∫≠p h·ªç v√† t√™n" />
                                    <ValidationMessage For="@(() => editModel.Name)" class="validation-message" />
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <InputText @bind-Value="editModel.Email" class="form-input" placeholder="Nh·∫≠p email" disabled />
                                    <span class="form-hint">Email kh√¥ng th·ªÉ thay ƒë·ªïi</span>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                                    <InputText @bind-Value="editModel.Phone" class="form-input" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" />
                                    <ValidationMessage For="@(() => editModel.Phone)" class="validation-message" />
                                </div>

                                <div class="form-group">
                                    <label class="form-label">ƒê·ªãa ch·ªâ</label>
                                    <InputTextArea @bind-Value="editModel.Address" class="form-input form-textarea" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng" rows="3" />
                                    <ValidationMessage For="@(() => editModel.Address)" class="validation-message" />
                                </div>

                                <div class="form-actions">
                                    <button type="button" class="btn btn-outline" @onclick="CancelEditing">H·ªßy</button>
                                    <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                        @(isSaving ? "ƒêang l∆∞u..." : "L∆∞u thay ƒë·ªïi")
                                    </button>
                                </div>
                            </EditForm>
                        }
                        else
                        {
                            <div class="profile-info">
                                <div class="info-item">
                                    <span class="info-label">H·ªç v√† t√™n</span>
                                    <span class="info-value">@AuthService.CurrentCustomer?.Name</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Email</span>
                                    <span class="info-value">@AuthService.CurrentCustomer?.Email</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">S·ªë ƒëi·ªán tho·∫°i</span>
                                    <span class="info-value">@(AuthService.CurrentCustomer?.Phone ?? "Ch∆∞a c·∫≠p nh·∫≠t")</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ƒê·ªãa ch·ªâ</span>
                                    <span class="info-value">@(AuthService.CurrentCustomer?.Address ?? "Ch∆∞a c·∫≠p nh·∫≠t")</span>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Change Password Card -->
                    <div class="content-card">
                        <div class="card-header">
                            <h2>ƒê·ªïi m·∫≠t kh·∫©u</h2>
                        </div>

                        @if (showChangePassword)
                        {
                            <EditForm Model="@passwordModel" OnValidSubmit="HandleChangePassword" class="profile-form">
                                <DataAnnotationsValidator />

                                <div class="form-group">
                                    <label class="form-label">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                                    <InputText type="password" @bind-Value="passwordModel.CurrentPassword" class="form-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i" />
                                    <ValidationMessage For="@(() => passwordModel.CurrentPassword)" class="validation-message" />
                                </div>

                                <div class="form-group">
                                    <label class="form-label">M·∫≠t kh·∫©u m·ªõi</label>
                                    <InputText type="password" @bind-Value="passwordModel.NewPassword" class="form-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi" />
                                    <ValidationMessage For="@(() => passwordModel.NewPassword)" class="validation-message" />
                                </div>

                                <div class="form-group">
                                    <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                                    <InputText type="password" @bind-Value="passwordModel.ConfirmPassword" class="form-input" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" />
                                    <ValidationMessage For="@(() => passwordModel.ConfirmPassword)" class="validation-message" />
                                </div>

                                <div class="form-actions">
                                    <button type="button" class="btn btn-outline" @onclick="@(() => showChangePassword = false)">H·ªßy</button>
                                    <button type="submit" class="btn btn-primary" disabled="@isChangingPassword">
                                        @(isChangingPassword ? "ƒêang l∆∞u..." : "ƒê·ªïi m·∫≠t kh·∫©u")
                                    </button>
                                </div>
                            </EditForm>
                        }
                        else
                        {
                            <div class="change-password-cta">
                                <p>ƒê·ªÉ b·∫£o m·∫≠t t√†i kho·∫£n, b·∫°n n√™n ƒë·ªïi m·∫≠t kh·∫©u ƒë·ªãnh k·ª≥.</p>
                                <button class="btn btn-secondary" @onclick="@(() => showChangePassword = true)">
                                    üîí ƒê·ªïi m·∫≠t kh·∫©u
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isEditing = false;
    private bool isSaving = false;
    private bool showChangePassword = false;
    private bool isChangingPassword = false;
    private string? successMessage;
    private string? errorMessage;

    private ProfileEditModel editModel = new();
    private PasswordChangeModel passwordModel = new();

    protected override void OnInitialized()
    {
        if (AuthService.CurrentCustomer != null)
        {
            editModel = new ProfileEditModel
            {
                Name = AuthService.CurrentCustomer.Name ?? "",
                Email = AuthService.CurrentCustomer.Email ?? "",
                Phone = AuthService.CurrentCustomer.Phone ?? "",
                Address = AuthService.CurrentCustomer.Address ?? ""
            };
        }
    }

    private void StartEditing()
    {
        isEditing = true;
        errorMessage = null;
        successMessage = null;
    }

    private void CancelEditing()
    {
        isEditing = false;
        if (AuthService.CurrentCustomer != null)
        {
            editModel = new ProfileEditModel
            {
                Name = AuthService.CurrentCustomer.Name ?? "",
                Email = AuthService.CurrentCustomer.Email ?? "",
                Phone = AuthService.CurrentCustomer.Phone ?? "",
                Address = AuthService.CurrentCustomer.Address ?? ""
            };
        }
    }

    private async Task HandleUpdateProfile()
    {
        isSaving = true;
        errorMessage = null;
        successMessage = null;
        StateHasChanged();

        try
        {
            var success = await AuthService.UpdateProfileAsync(
                editModel.Name,
                editModel.Phone,
                editModel.Address
            );

            if (success)
            {
                successMessage = "C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!";
                isEditing = false;
            }
            else
            {
                errorMessage = "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√¥ng tin. Vui l√≤ng th·ª≠ l·∫°i.";
            }
        }
        catch
        {
            errorMessage = "ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task HandleChangePassword()
    {
        if (passwordModel.NewPassword != passwordModel.ConfirmPassword)
        {
            errorMessage = "M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp.";
            return;
        }

        isChangingPassword = true;
        errorMessage = null;
        successMessage = null;
        StateHasChanged();

        try
        {
            var success = await AuthService.ChangePasswordAsync(
                passwordModel.CurrentPassword,
                passwordModel.NewPassword
            );

            if (success)
            {
                successMessage = "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!";
                showChangePassword = false;
                passwordModel = new PasswordChangeModel();
            }
            else
            {
                errorMessage = "M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng.";
            }
        }
        catch
        {
            errorMessage = "ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.";
        }
        finally
        {
            isChangingPassword = false;
            StateHasChanged();
        }
    }

    private void HandleLogout()
    {
        AuthService.Logout();
        Navigation.NavigateTo("/");
    }

    public class ProfileEditModel
    {
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public string? Phone { get; set; }
        public string? Address { get; set; }
    }

    public class PasswordChangeModel
    {
        public string CurrentPassword { get; set; } = "";
        public string NewPassword { get; set; } = "";
        public string ConfirmPassword { get; set; } = "";
    }
}
