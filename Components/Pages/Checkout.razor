@page "/checkout"
@rendermode InteractiveServer
@inject ICartService CartService
@inject ICustomerAuthService AuthService
@inject IOrderService OrderService
@inject NavigationManager Navigation

<PageTitle>Thanh to√°n - Stuffsus</PageTitle>

@if (!AuthService.IsAuthenticated)
{
    <div class="not-authenticated">
        <h2>Vui l√≤ng ƒëƒÉng nh·∫≠p</h2>
        <p>B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c thanh to√°n</p>
        <a href="/login?returnUrl=/checkout" class="btn btn-primary btn-lg">ƒêƒÉng nh·∫≠p</a>
    </div>
}
else if (cart.Items.Count == 0)
{
    <div class="empty-cart-checkout">
        <h2>Gi·ªè h√†ng tr·ªëng</h2>
        <p>B·∫°n ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë·ªÉ thanh to√°n</p>
        <a href="/shop" class="btn btn-primary btn-lg">Ti·∫øp t·ª•c mua s·∫Øm</a>
    </div>
}
else
{
    <div class="checkout-page">
        <div class="container">
            <h1 class="page-title">Thanh to√°n</h1>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-error">
                    @errorMessage
                </div>
            }

            <div class="checkout-layout">
                <!-- Checkout Form -->
                <div class="checkout-form">
                    <!-- Customer Info -->
                    <div class="checkout-section">
                        <h2 class="section-title">
                            <span class="step-number">1</span>
                            Th√¥ng tin giao h√†ng
                        </h2>
                        <div class="customer-info">
                            <div class="info-row">
                                <span class="info-label">H·ªç t√™n:</span>
                                <span class="info-value">@AuthService.CurrentCustomer?.Name</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Email:</span>
                                <span class="info-value">@AuthService.CurrentCustomer?.Email</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ƒêi·ªán tho·∫°i:</span>
                                <span class="info-value">@(AuthService.CurrentCustomer?.Phone ?? "Ch∆∞a c·∫≠p nh·∫≠t")</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ƒê·ªãa ch·ªâ:</span>
                                <span class="info-value">@(AuthService.CurrentCustomer?.Address ?? "Ch∆∞a c·∫≠p nh·∫≠t")</span>
                            </div>
                        </div>
                    </div>

                    <!-- Promo Code -->
                    <div class="checkout-section">
                        <h2 class="section-title">
                            <span class="step-number">2</span>
                            M√£ gi·∫£m gi√°
                        </h2>
                        <div class="promo-form">
                            <input type="text" @bind="promoCode" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°" class="form-input" />
                            <button class="btn btn-secondary" @onclick="ApplyPromoCode" disabled="@isApplyingPromo">
                                @(isApplyingPromo ? "ƒêang ki·ªÉm tra..." : "√Åp d·ª•ng")
                            </button>
                        </div>
                        @if (appliedPromo != null)
                        {
                            <div class="promo-applied">
                                <span class="promo-tag">‚úì @appliedPromo.PromoCode</span>
                                <span class="promo-desc">@appliedPromo.Description</span>
                                <button class="remove-promo" @onclick="RemovePromo">√ó</button>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(promoError))
                        {
                            <p class="promo-error">@promoError</p>
                        }
                    </div>

                    <!-- Payment Method -->
                    <div class="checkout-section">
                        <h2 class="section-title">
                            <span class="step-number">3</span>
                            Ph∆∞∆°ng th·ª©c thanh to√°n
                        </h2>
                        <div class="payment-options">
                            <label class="payment-option @(paymentMethod == "cash" ? "selected" : "")">
                                <input type="radio" name="payment" value="cash" @onchange="@(() => paymentMethod = "cash")" checked="@(paymentMethod == "cash")" />
                                <div class="payment-content">
                                    <span class="payment-icon">üíµ</span>
                                    <div class="payment-info">
                                        <span class="payment-name">Ti·ªÅn m·∫∑t</span>
                                        <span class="payment-desc">Thanh to√°n khi nh·∫≠n h√†ng (COD)</span>
                                    </div>
                                </div>
                            </label>
                            <label class="payment-option @(paymentMethod == "card" ? "selected" : "")">
                                <input type="radio" name="payment" value="card" @onchange="@(() => paymentMethod = "card")" checked="@(paymentMethod == "card")" />
                                <div class="payment-content">
                                    <span class="payment-icon">üí≥</span>
                                    <div class="payment-info">
                                        <span class="payment-name">Th·∫ª t√≠n d·ª•ng/Ghi n·ª£</span>
                                        <span class="payment-desc">Visa, Mastercard, JCB</span>
                                    </div>
                                </div>
                            </label>
                            <label class="payment-option @(paymentMethod == "bank_transfer" ? "selected" : "")">
                                <input type="radio" name="payment" value="bank_transfer" @onchange="@(() => paymentMethod = "bank_transfer")" checked="@(paymentMethod == "bank_transfer")" />
                                <div class="payment-content">
                                    <span class="payment-icon">üè¶</span>
                                    <div class="payment-info">
                                        <span class="payment-name">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</span>
                                        <span class="payment-desc">Chuy·ªÉn kho·∫£n qua t√†i kho·∫£n ng√¢n h√†ng</span>
                                    </div>
                                </div>
                            </label>
                            <label class="payment-option @(paymentMethod == "e-wallet" ? "selected" : "")">
                                <input type="radio" name="payment" value="e-wallet" @onchange="@(() => paymentMethod = "e-wallet")" checked="@(paymentMethod == "e-wallet")" />
                                <div class="payment-content">
                                    <span class="payment-icon">üì±</span>
                                    <div class="payment-info">
                                        <span class="payment-name">V√≠ ƒëi·ªán t·ª≠</span>
                                        <span class="payment-desc">MoMo, ZaloPay, VNPay</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="order-summary">
                    <div class="summary-card">
                        <h2 class="summary-title">ƒê∆°n h√†ng c·ªßa b·∫°n</h2>
                        
                        <div class="order-items">
                            @foreach (var item in cart.Items)
                            {
                                <div class="order-item">
                                    <div class="item-image-small">
                                        <div class="placeholder-small">üì¶</div>
                                    </div>
                                    <div class="item-details">
                                        <span class="item-name">@item.ProductName</span>
                                        <span class="item-qty">x@item.Quantity</span>
                                    </div>
                                    <span class="item-total">@item.Subtotal.ToString("N0")‚Ç´</span>
                                </div>
                            }
                        </div>

                        <div class="summary-divider"></div>

                        <div class="summary-row">
                            <span>T·∫°m t√≠nh</span>
                            <span>@cart.TotalAmount.ToString("N0")‚Ç´</span>
                        </div>
                        
                        @if (discountAmount > 0)
                        {
                            <div class="summary-row discount">
                                <span>Gi·∫£m gi√°</span>
                                <span>-@discountAmount.ToString("N0")‚Ç´</span>
                            </div>
                        }
                        
                        <div class="summary-row">
                            <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                            <span class="free">Mi·ªÖn ph√≠</span>
                        </div>
                        
                        <div class="summary-divider"></div>
                        
                        <div class="summary-total">
                            <span>T·ªïng c·ªông</span>
                            <span class="total-amount">@((cart.TotalAmount - discountAmount).ToString("N0"))‚Ç´</span>
                        </div>

                        <button class="btn btn-primary btn-lg place-order-btn" @onclick="PlaceOrder" disabled="@isPlacingOrder">
                            @if (isPlacingOrder)
                            {
                                <span class="spinner"></span>
                                <span>ƒêang x·ª≠ l√Ω...</span>
                            }
                            else
                            {
                                <span>ƒê·∫∑t h√†ng</span>
                            }
                        </button>

                        <p class="terms-note">
                            B·∫±ng vi·ªác ƒë·∫∑t h√†ng, b·∫°n ƒë·ªìng √Ω v·ªõi <a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a> v√† <a href="#">Ch√≠nh s√°ch b·∫£o m·∫≠t</a> c·ªßa ch√∫ng t√¥i.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private Models.Cart cart = new Models.Cart();
    private string paymentMethod = "cash";
    private string promoCode = "";
    private Models.Promotion? appliedPromo;
    private decimal discountAmount = 0;
    private string? promoError;
    private string? errorMessage;
    private bool isApplyingPromo = false;
    private bool isPlacingOrder = false;

    protected override void OnInitialized()
    {
        cart = CartService.GetCart();
        CartService.OnChange += RefreshCart;
    }

    private void RefreshCart()
    {
        cart = CartService.GetCart();
        InvokeAsync(StateHasChanged);
    }

    private async Task ApplyPromoCode()
    {
        if (string.IsNullOrWhiteSpace(promoCode))
        {
            promoError = "Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°";
            return;
        }

        isApplyingPromo = true;
        promoError = null;
        StateHasChanged();

        try
        {
            var promo = await OrderService.ValidatePromoCodeAsync(promoCode.Trim().ToUpper(), cart.TotalAmount);
            
            if (promo != null)
            {
                appliedPromo = promo;
                discountAmount = await OrderService.CalculateDiscountAsync(promo, cart.TotalAmount);
                promoCode = "";
            }
            else
            {
                promoError = "M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng √°p d·ª•ng ƒë∆∞·ª£c cho ƒë∆°n h√†ng n√†y";
            }
        }
        catch
        {
            promoError = "ƒê√£ x·∫£y ra l·ªói khi ki·ªÉm tra m√£ gi·∫£m gi√°";
        }
        finally
        {
            isApplyingPromo = false;
            StateHasChanged();
        }
    }

    private void RemovePromo()
    {
        appliedPromo = null;
        discountAmount = 0;
    }

    private async Task PlaceOrder()
    {
        if (AuthService.CurrentCustomer == null)
        {
            Navigation.NavigateTo("/login?returnUrl=/checkout");
            return;
        }

        isPlacingOrder = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var order = await OrderService.CreateOrderAsync(
                AuthService.CurrentCustomer.CustomerId,
                cart,
                appliedPromo?.PromoId,
                paymentMethod
            );

            CartService.ClearCart();
            Navigation.NavigateTo($"/order-success/{order.OrderId}");
        }
        catch (Exception ex)
        {
            errorMessage = "ƒê√£ x·∫£y ra l·ªói khi ƒë·∫∑t h√†ng. Vui l√≤ng th·ª≠ l·∫°i.";
        }
        finally
        {
            isPlacingOrder = false;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        CartService.OnChange -= RefreshCart;
    }
}
