@page "/orders"
@rendermode InteractiveServer
@inject IOrderService OrderService
@inject ICustomerAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>ƒê∆°n h√†ng c·ªßa t√¥i - Stuffsus</PageTitle>

@if (!AuthService.IsAuthenticated)
{
    <div class="not-authenticated">
        <h2>Vui l√≤ng ƒëƒÉng nh·∫≠p</h2>
        <p>B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem ƒë∆°n h√†ng c·ªßa m√¨nh</p>
        <a href="/login?returnUrl=/orders" class="btn btn-primary btn-lg">ƒêƒÉng nh·∫≠p</a>
    </div>
}
else
{
    <div class="orders-page">
        <div class="container">
            <h1 class="page-title">ƒê∆°n h√†ng c·ªßa t√¥i</h1>

            @if (isLoading)
            {
                <div class="loading-container">
                    <div class="spinner-large"></div>
                    <p>ƒêang t·∫£i ƒë∆°n h√†ng...</p>
                </div>
            }
            else if (orders == null || orders.Count == 0)
            {
                <div class="empty-orders">
                    <div class="empty-icon">üì¶</div>
                    <h2>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h2>
                    <p>B·∫°n ch∆∞a ƒë·∫∑t ƒë∆°n h√†ng n√†o. H√£y kh√°m ph√° c√°c s·∫£n ph·∫©m c·ªßa ch√∫ng t√¥i!</p>
                    <a href="/shop" class="btn btn-primary btn-lg">B·∫Øt ƒë·∫ßu mua s·∫Øm</a>
                </div>
            }
            else
            {
                <div class="orders-list">
                    @foreach (var order in orders)
                    {
                        <div class="order-card">
                            <div class="order-header">
                                <div class="order-info">
                                    <span class="order-id">ƒê∆°n h√†ng #@order.OrderId.ToString("D6")</span>
                                    <span class="order-date">@order.OrderDate.ToString("dd/MM/yyyy HH:mm")</span>
                                </div>
                                <div class="order-status @GetStatusClass(order.Status)">
                                    @GetStatusText(order.Status)
                                </div>
                            </div>

                            <div class="order-items-preview">
                                @if (order.OrderItems != null)
                                {
                                    @foreach (var item in order.OrderItems.Take(3))
                                    {
                                        <div class="item-preview">
                                            <div class="item-image-tiny">üì¶</div>
                                            <div class="item-detail">
                                                <span class="item-name">@item.Product?.ProductName</span>
                                                <span class="item-qty">x@item.Quantity</span>
                                            </div>
                                        </div>
                                    }
                                    @if (order.OrderItems.Count > 3)
                                    {
                                        <div class="more-items">
                                            +@(order.OrderItems.Count - 3) s·∫£n ph·∫©m kh√°c
                                        </div>
                                    }
                                }
                            </div>

                            <div class="order-footer">
                                <div class="order-total">
                                    <span class="label">T·ªïng ti·ªÅn:</span>
                                    <span class="amount">@order.TotalAmount.ToString("N0")‚Ç´</span>
                                </div>
                                <div class="order-actions">
                                    <button class="btn btn-outline btn-sm" @onclick="@(() => ToggleOrderDetails(order.OrderId))">
                                        @(expandedOrderId == order.OrderId ? "·∫®n chi ti·∫øt" : "Xem chi ti·∫øt")
                                    </button>
                                    @if (order.Status == "pending")
                                    {
                                        <button class="btn btn-danger btn-sm" @onclick="@(() => CancelOrder(order.OrderId))">
                                            H·ªßy ƒë∆°n
                                        </button>
                                    }
                                </div>
                            </div>

                            @if (expandedOrderId == order.OrderId)
                            {
                                <div class="order-details-expanded">
                                    <div class="details-section">
                                        <h4>Chi ti·∫øt s·∫£n ph·∫©m</h4>
                                        @if (order.OrderItems != null)
                                        {
                                            @foreach (var item in order.OrderItems)
                                            {
                                                <div class="detail-item">
                                                    <div class="item-image-small">üì¶</div>
                                                    <div class="item-info">
                                                        <span class="name">@item.Product?.ProductName</span>
                                                        <span class="price">@item.Price.ToString("N0")‚Ç´ x @item.Quantity</span>
                                                    </div>
                                                    <span class="subtotal">@item.Subtotal.ToString("N0")‚Ç´</span>
                                                </div>
                                            }
                                        }
                                    </div>

                                    <div class="details-section">
                                        <h4>Th√¥ng tin thanh to√°n</h4>
                                        @if (order.Payments != null && order.Payments.Count > 0)
                                        {
                                            var payment = order.Payments.First();
                                            <div class="payment-info">
                                                <div class="info-row">
                                                    <span>Ph∆∞∆°ng th·ª©c:</span>
                                                    <span>@GetPaymentMethod(payment.PaymentMethod)</span>
                                                </div>
                                                <div class="info-row">
                                                    <span>Tr·∫°ng th√°i:</span>
                                                    <span class="@GetPaymentStatusClass(payment.PaymentStatus)">
                                                        @GetPaymentStatusText(payment.PaymentStatus)
                                                    </span>
                                                </div>
                                                <div class="info-row">
                                                    <span>S·ªë ti·ªÅn:</span>
                                                    <span class="amount">@payment.Amount.ToString("N0")‚Ç´</span>
                                                </div>
                                            </div>
                                        }
                                    </div>

                                    <div class="details-summary">
                                        <div class="summary-row">
                                            <span>T·∫°m t√≠nh:</span>
                                            <span>@order.OrderItems?.Sum(i => i.Subtotal).ToString("N0")‚Ç´</span>
                                        </div>
                                        @if (order.DiscountAmount > 0)
                                        {
                                            <div class="summary-row discount">
                                                <span>Gi·∫£m gi√°:</span>
                                                <span>-@order.DiscountAmount.ToString("N0")‚Ç´</span>
                                            </div>
                                        }
                                        <div class="summary-row total">
                                            <span>T·ªïng c·ªông:</span>
                                            <span>@order.TotalAmount.ToString("N0")‚Ç´</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}

@code {
    private List<Order>? orders;
    private bool isLoading = true;
    private int? expandedOrderId;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            return;
        }

        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            if (AuthService.CurrentCustomer != null)
            {
                orders = await OrderService.GetCustomerOrdersAsync(AuthService.CurrentCustomer.CustomerId);
            }
        }
        catch
        {
            orders = new List<Order>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ToggleOrderDetails(int orderId)
    {
        if (expandedOrderId == orderId)
        {
            expandedOrderId = null;
        }
        else
        {
            expandedOrderId = orderId;
        }
    }

    private async Task CancelOrder(int orderId)
    {
        try
        {
            await OrderService.CancelOrderAsync(orderId);
            await LoadOrders();
        }
        catch
        {
            // Show error notification
        }
    }

    private string GetStatusText(string? status)
    {
        return status switch
        {
            "pending" => "Ch·ªù x·ª≠ l√Ω",
            "processing" => "ƒêang x·ª≠ l√Ω",
            "shipped" => "ƒêang giao",
            "delivered" => "ƒê√£ giao",
            "cancelled" => "ƒê√£ h·ªßy",
            _ => "Ch·ªù x·ª≠ l√Ω"
        };
    }

    private string GetStatusClass(string? status)
    {
        return status switch
        {
            "pending" => "status-pending",
            "processing" => "status-processing",
            "shipped" => "status-shipped",
            "delivered" => "status-delivered",
            "cancelled" => "status-cancelled",
            _ => "status-pending"
        };
    }

    private string GetPaymentMethod(string? method)
    {
        return method switch
        {
            "cash" => "Ti·ªÅn m·∫∑t (COD)",
            "card" => "Th·∫ª t√≠n d·ª•ng",
            "bank_transfer" => "Chuy·ªÉn kho·∫£n",
            "e-wallet" => "V√≠ ƒëi·ªán t·ª≠",
            _ => "Ti·ªÅn m·∫∑t"
        };
    }

    private string GetPaymentStatusText(string? status)
    {
        return status switch
        {
            "pending" => "Ch·ªù thanh to√°n",
            "completed" => "ƒê√£ thanh to√°n",
            "failed" => "Th·∫•t b·∫°i",
            "refunded" => "ƒê√£ ho√†n ti·ªÅn",
            _ => "Ch·ªù thanh to√°n"
        };
    }

    private string GetPaymentStatusClass(string? status)
    {
        return status switch
        {
            "completed" => "text-success",
            "failed" => "text-danger",
            "refunded" => "text-warning",
            _ => "text-muted"
        };
    }
}
