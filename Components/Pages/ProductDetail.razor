@page "/product/{ProductId:int}"
@rendermode InteractiveServer
@inject IProductService ProductService
@inject ICartService CartService
@inject IToastService ToastService
@inject NavigationManager Navigation

<PageTitle>@(product?.ProductName ?? "Sản phẩm") - Stuffsus</PageTitle>

@if (isLoading)
{
    <div class="loading-page">
        <div class="loading-spinner"></div>
        <p>Đang tải sản phẩm...</p>
    </div>
}
else if (product == null)
{
    <div class="not-found-page">
        <h1>404</h1>
        <p>Không tìm thấy sản phẩm</p>
        <a href="/shop" class="btn btn-primary">Quay lại cửa hàng</a>
    </div>
}
else
{
    <div class="product-detail-page">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <div class="container">
                <a href="/">Trang chủ</a>
                <span>/</span>
                <a href="/shop">Shop</a>
                <span>/</span>
                @if (product.Category != null)
                {
                    <a href="/shop?category=@product.CategoryId">@product.Category.CategoryName</a>
                    <span>/</span>
                }
                <span class="current">@product.ProductName</span>
            </div>
        </nav>

        <div class="container">
            <div class="product-detail-grid">
                <!-- Product Image -->
                <div class="product-gallery">
                    <div class="main-image">
                        @if (!string.IsNullOrEmpty(product.ImageUrl))
                        {
                            <img src="@product.ImageUrl" alt="@product.ProductName" class="product-img-large" />
                        }
                        else
                        {
                            <div class="product-placeholder-large">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                            </div>
                        }
                        <span class="product-badge-large">@product.Category?.CategoryName</span>
                    </div>
                </div>

                <!-- Product Info -->
                <div class="product-details">
                    <div class="product-header">
                        <span class="product-category-tag">@product.Category?.CategoryName</span>
                        <h1 class="product-title">@product.ProductName</h1>
                        <div class="product-rating-large">
                            <span class="stars">★★★★★</span>
                            <span class="rating-value">4.@((product.ProductId % 5) + 5)</span>
                            <span class="review-count">(@((product.ProductId * 23) % 1000 + 100) đánh giá)</span>
                        </div>
                    </div>

                    <div class="product-price-section">
                        <span class="current-price">@product.Price.ToString("N0")₫</span>
                        <span class="unit">/ @product.Unit</span>
                    </div>

                    <div class="product-meta-info">
                        <div class="meta-item">
                            <span class="meta-label">Mã vạch:</span>
                            <span class="meta-value">@(product.Barcode ?? "N/A")</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Nhà cung cấp:</span>
                            <span class="meta-value">@(product.Supplier?.Name ?? "N/A")</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Tình trạng:</span>
                            @if (product.Inventory?.Quantity > 0)
                            {
                                <span class="meta-value in-stock">Còn @product.Inventory.Quantity @product.Unit</span>
                            }
                            else
                            {
                                <span class="meta-value out-of-stock">Hết hàng</span>
                            }
                        </div>
                    </div>

                    <!-- Quantity Selector -->
                    <div class="quantity-section">
                        <label class="quantity-label">Số lượng:</label>
                        <div class="quantity-selector">
                            <button class="qty-btn" @onclick="DecreaseQuantity" disabled="@(quantity <= 1)">−</button>
                            <input type="number" @bind="quantity" min="1" max="@(product.Inventory?.Quantity ?? 1)" class="qty-input" />
                            <button class="qty-btn" @onclick="IncreaseQuantity" disabled="@(quantity >= (product.Inventory?.Quantity ?? 1))">+</button>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="product-actions-large">
                        <button class="btn btn-secondary btn-lg" @onclick="AddToCart" 
                                disabled="@(product.Inventory?.Quantity <= 0)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="8" cy="21" r="1"></circle>
                                <circle cx="19" cy="21" r="1"></circle>
                                <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path>
                            </svg>
                            Thêm vào giỏ
                        </button>
                        <button class="btn btn-primary btn-lg" @onclick="BuyNow"
                                disabled="@(product.Inventory?.Quantity <= 0)">
                            Mua ngay
                        </button>
                    </div>

                    <!-- Product Description -->
                    <div class="product-description">
                        <h3>Mô tả sản phẩm</h3>
                        <p>
                            @product.ProductName là sản phẩm chất lượng cao thuộc danh mục @(product.Category?.CategoryName ?? "khác"). 
                            Sản phẩm được cung cấp bởi @(product.Supplier?.Name ?? "nhà cung cấp uy tín") với giá cả hợp lý.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int ProductId { get; set; }

    private Product? product;
    private bool isLoading = true;
    private int quantity = 1;

    protected override async Task OnInitializedAsync()
    {
        await LoadProduct();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadProduct();
    }

    private async Task LoadProduct()
    {
        isLoading = true;
        product = await ProductService.GetProductByIdAsync(ProductId);
        isLoading = false;
    }

    private void IncreaseQuantity()
    {
        if (product?.Inventory?.Quantity > quantity)
        {
            quantity++;
        }
    }

    private void DecreaseQuantity()
    {
        if (quantity > 1)
        {
            quantity--;
        }
    }

    private void AddToCart()
    {
        if (product != null)
        {
            for (int i = 0; i < quantity; i++)
            {
                CartService.AddToCart(product);
            }
            ToastService.ShowSuccess($"Đã thêm {quantity} \"{product.ProductName}\" vào giỏ hàng", "Giỏ hàng");
        }
    }

    private void BuyNow()
    {
        if (product != null)
        {
            for (int i = 0; i < quantity; i++)
            {
                CartService.AddToCart(product);
            }
            Navigation.NavigateTo("/cart");
        }
    }
}
