@page "/cart"
@rendermode InteractiveServer
@inject ICartService CartService
@inject ICustomerAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Giỏ hàng - Stuffsus</PageTitle>

<div class="cart-page">
    <div class="container">
        <h1 class="page-title">Giỏ hàng của bạn</h1>

        @if (cart.Items.Count == 0)
        {
            <div class="empty-cart">
                <div class="empty-icon"><i class="hgi-stroke hgi-shopping-cart-01"></i></div>
                <h2>Giỏ hàng trống</h2>
                <p>Bạn chưa có sản phẩm nào trong giỏ hàng</p>
                <a href="/shop" class="btn btn-primary btn-lg">Tiếp tục mua sắm</a>
            </div>
        }
        else
        {
            <div class="cart-layout">
                <!-- Cart Items -->
                <div class="cart-items">
                    <div class="cart-header">
                        <span class="header-product">Sản phẩm</span>
                        <span class="header-price">Đơn giá</span>
                        <span class="header-quantity">Số lượng</span>
                        <span class="header-subtotal">Thành tiền</span>
                        <span class="header-action"></span>
                    </div>

                    @foreach (var item in cart.Items)
                    {
                        <div class="cart-item">
                            <div class="item-product">
                                <div class="item-image">
                                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                                    {
                                        <img src="@item.ImageUrl" alt="@item.ProductName" class="product-img" />
                                    }
                                    else
                                    {
                                        <div class="product-placeholder-small">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                                <polyline points="21 15 16 10 5 21"></polyline>
                                            </svg>
                                        </div>
                                    }
                                </div>
                                <div class="item-info">
                                    <h3 class="item-name">@item.ProductName</h3>
                                    <span class="item-category">@item.CategoryName</span>
                                </div>
                            </div>
                            
                            <div class="item-price">
                                @item.Price.ToString("N0")₫
                            </div>
                            
                            <div class="item-quantity">
                                <div class="quantity-controls">
                                    <button class="qty-btn" @onclick="() => DecreaseQuantity(item.ProductId)">−</button>
                                    <span class="qty-value">@item.Quantity</span>
                                    <button class="qty-btn" @onclick="() => IncreaseQuantity(item.ProductId)">+</button>
                                </div>
                            </div>
                            
                            <div class="item-subtotal">
                                @item.Subtotal.ToString("N0")₫
                            </div>
                            
                            <div class="item-action">
                                <button class="remove-btn" @onclick="() => RemoveItem(item.ProductId)">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    }

                    <div class="cart-actions">
                        <button class="btn btn-secondary" @onclick="ClearCart">
                            Xóa tất cả
                        </button>
                        <a href="/shop" class="btn btn-outline">
                            Tiếp tục mua sắm
                        </a>
                    </div>
                </div>

                <!-- Cart Summary -->
                <div class="cart-summary">
                    <div class="summary-card">
                        <h2 class="summary-title">Tóm tắt đơn hàng</h2>
                        
                        <div class="summary-row">
                            <span>Tổng sản phẩm</span>
                            <span>@cart.TotalItems sản phẩm</span>
                        </div>
                        
                        <div class="summary-row">
                            <span>Tạm tính</span>
                            <span>@cart.TotalAmount.ToString("N0")₫</span>
                        </div>
                        
                        <div class="summary-row">
                            <span>Phí vận chuyển</span>
                            <span class="free">Miễn phí</span>
                        </div>
                        
                        <div class="summary-divider"></div>
                        
                        <div class="summary-total">
                            <span>Tổng cộng</span>
                            <span class="total-amount">@cart.TotalAmount.ToString("N0")₫</span>
                        </div>
                        
                        <button class="btn btn-primary btn-lg checkout-btn" @onclick="ProceedToCheckout">
                            Tiến hành thanh toán
                        </button>
                        
                        <p class="secure-note">
                            <i class="hgi-stroke hgi-square-lock-02"></i> Thanh toán an toàn và bảo mật
                        </p>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private Models.Cart cart = new Models.Cart();

    protected override void OnInitialized()
    {
        CartService.OnChange += RefreshCart;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CartService.LoadCartFromStorageAsync();
            cart = CartService.GetCart();
            StateHasChanged();
        }
    }

    private void RefreshCart()
    {
        cart = CartService.GetCart();
        InvokeAsync(StateHasChanged);
    }

    private void IncreaseQuantity(int productId)
    {
        var item = cart.Items.FirstOrDefault(i => i.ProductId == productId);
        if (item != null)
        {
            CartService.UpdateQuantity(productId, item.Quantity + 1);
        }
    }

    private void DecreaseQuantity(int productId)
    {
        var item = cart.Items.FirstOrDefault(i => i.ProductId == productId);
        if (item != null && item.Quantity > 1)
        {
            CartService.UpdateQuantity(productId, item.Quantity - 1);
        }
    }

    private void RemoveItem(int productId)
    {
        CartService.RemoveFromCart(productId);
    }

    private void ClearCart()
    {
        CartService.ClearCart();
    }

    private void ProceedToCheckout()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login?returnUrl=/checkout", forceLoad: false);
        }
        else
        {
            Navigation.NavigateTo("/checkout", forceLoad: false);
        }
    }

    public void Dispose()
    {
        CartService.OnChange -= RefreshCart;
    }
}
