@page "/order-success/{OrderId:int}"
@rendermode InteractiveServer
@inject IOrderService OrderService
@inject ICustomerAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Äáº·t hÃ ng thÃ nh cÃ´ng - Stuffsus</PageTitle>

@if (order == null)
{
    <div class="loading-container">
        <div class="spinner-large"></div>
        <p>Äang táº£i thÃ´ng tin Ä‘Æ¡n hÃ ng...</p>
    </div>
}
else
{
    <div class="order-success-page">
        <div class="container">
            <div class="success-card">
                <div class="success-icon">
                    <span>âœ“</span>
                </div>
                <h1 class="success-title">Äáº·t hÃ ng thÃ nh cÃ´ng!</h1>
                <p class="success-message">
                    Cáº£m Æ¡n báº¡n Ä‘Ã£ mua hÃ ng táº¡i Stuffsus. ÄÆ¡n hÃ ng cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c tiáº¿p nháº­n vÃ  Ä‘ang Ä‘Æ°á»£c xá»­ lÃ½.
                </p>
                
                <div class="order-number">
                    <span class="label">MÃ£ Ä‘Æ¡n hÃ ng:</span>
                    <span class="value">#@order.OrderId.ToString("D6")</span>
                </div>

                <div class="order-info-grid">
                    <div class="info-card">
                        <span class="info-icon">ğŸ“…</span>
                        <span class="info-label">NgÃ y Ä‘áº·t</span>
                        <span class="info-value">@order.OrderDate.ToString("dd/MM/yyyy HH:mm")</span>
                    </div>
                    <div class="info-card">
                        <span class="info-icon">ğŸ“¦</span>
                        <span class="info-label">Tráº¡ng thÃ¡i</span>
                        <span class="info-value status-pending">@GetStatusText(order.Status)</span>
                    </div>
                    <div class="info-card">
                        <span class="info-icon">ğŸ’°</span>
                        <span class="info-label">Tá»•ng tiá»n</span>
                        <span class="info-value">@order.TotalAmount.ToString("N0")â‚«</span>
                    </div>
                    <div class="info-card">
                        <span class="info-icon">ğŸ’³</span>
                        <span class="info-label">Thanh toÃ¡n</span>
                        <span class="info-value">@GetPaymentMethod(order.Payments.FirstOrDefault()?.PaymentMethod)</span>
                    </div>
                </div>

                @if (order.OrderItems != null && order.OrderItems.Count > 0)
                {
                    <div class="order-items-section">
                        <h3>Chi tiáº¿t Ä‘Æ¡n hÃ ng</h3>
                        <div class="order-items-list">
                            @foreach (var item in order.OrderItems)
                            {
                                <div class="order-item-row">
                                    <div class="item-image-mini">ğŸ“¦</div>
                                    <div class="item-info">
                                        <span class="item-name">@item.Product?.ProductName</span>
                                        <span class="item-qty">Sá»‘ lÆ°á»£ng: @item.Quantity</span>
                                    </div>
                                    <span class="item-price">@item.Subtotal.ToString("N0")â‚«</span>
                                </div>
                            }
                        </div>
                    </div>
                }

                <div class="action-buttons">
                    <a href="/orders" class="btn btn-secondary">Xem Ä‘Æ¡n hÃ ng cá»§a tÃ´i</a>
                    <a href="/shop" class="btn btn-primary">Tiáº¿p tá»¥c mua sáº¯m</a>
                </div>

                <div class="email-notice">
                    <span class="icon">ğŸ“§</span>
                    <p>ChÃºng tÃ´i Ä‘Ã£ gá»­i email xÃ¡c nháº­n Ä‘áº¿n <strong>@AuthService.CurrentCustomer?.Email</strong>. 
                    Vui lÃ²ng kiá»ƒm tra há»™p thÆ° cá»§a báº¡n.</p>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int OrderId { get; set; }

    private Order? order;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        order = await OrderService.GetOrderByIdAsync(OrderId);
        
        // Verify order belongs to current customer
        if (order != null && order.CustomerId != AuthService.CurrentCustomer?.CustomerId)
        {
            Navigation.NavigateTo("/orders");
        }
    }

    private string GetStatusText(string? status)
    {
        return status switch
        {
            "pending" => "Chá» xá»­ lÃ½",
            "processing" => "Äang xá»­ lÃ½",
            "shipped" => "Äang giao",
            "delivered" => "ÄÃ£ giao",
            "cancelled" => "ÄÃ£ há»§y",
            _ => "Chá» xá»­ lÃ½"
        };
    }

    private string GetPaymentMethod(string? method)
    {
        return method switch
        {
            "cash" => "Tiá»n máº·t (COD)",
            "card" => "Tháº» tÃ­n dá»¥ng",
            "bank_transfer" => "Chuyá»ƒn khoáº£n",
            "e-wallet" => "VÃ­ Ä‘iá»‡n tá»­",
            _ => "Tiá»n máº·t"
        };
    }
}
